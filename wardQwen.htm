<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä½é™¢ç—…äººå•é¡Œç®¡ç† (FHIR)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1, h2 { color: #005b99; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    ul { list-style-type: none; padding: 0; }
    li { padding: 10px; margin: 5px 0; background: #f0f7ff; border-left: 4px solid #007bff; cursor: pointer; }
    li:hover { background: #e1eeff; }
    .active { background: #d1e7ff; border-left-color: #0056b3; }
    .form-group { margin: 15px 0; }
    input, button { padding: 8px 12px; font-size: 16px; }
    input { width: 70%; margin-right: 10px; }
    .conditions { margin-top: 20px; }
    .condition-item { padding: 8px; background: #f8f9fa; margin: 5px 0; border-radius: 4px; }
    .error { color: red; }
    .success { color: green; }
    .back-btn { margin-bottom: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¥ ä½é™¢ç—…äººå•é¡Œç®¡ç†ç³»çµ±</h1>
    <div id="view"></div>
  </div>

  <script>
    const FHIR_BASE = 'https://hapi.fhir.org/baseR4';
    const LOCATION_ID = 'f4c8a5f1-947a-4aea-9e53-3ac64739c4f2';

    // ä¸»ç•«é¢ï¼šåˆ—å‡ºé€²è¡Œä¸­ä½é™¢çš„ç—…äºº
    async function showPatientList() {
      const view = document.getElementById('view');
      view.innerHTML = '<p>è¼‰å…¥ä¸­...</p>';

      try {
        const response = await fetch(`${FHIR_BASE}/Encounter?status=in-progress&location=Location/${LOCATION_ID}`);
        const bundle = await response.json();

        if (!bundle.entry || bundle.entry.length === 0) {
          view.innerHTML = '<p>ç›®å‰ç„¡ä½é™¢ç—…äººã€‚</p>';
          return;
        }

        // å¾ Encounter æå–æ‰€æœ‰ unique Patient reference
        const patientRefs = new Set();
        bundle.entry.forEach(entry => {
          const encounter = entry.resource;
          if (encounter.subject && encounter.subject.reference) {
            patientRefs.add(encounter.subject.reference);
          }
        });

        const patientList = [];
        for (const ref of patientRefs) {
          // ref æ ¼å¼å¦‚ "Patient/12345"
          const patientId = ref.split('/')[1];
          const patientRes = await fetch(`${FHIR_BASE}/Patient/${patientId}`);
          if (patientRes.ok) {
            const patient = await patientRes.json();
            patientList.push(patient);
          }
        }

        let html = '<h2>ç¾æœ‰ä½é™¢ç—…äºº</h2><ul>';
        patientList.forEach(p => {
          const name = p.name?.[0]?.text ||
                      (p.name?.[0]?.given?.join(' ') + ' ' + (p.name?.[0]?.family || '')).trim() ||
                      'æœªå‘½å';
          html += `<li onclick="showPatientDetail('${p.id}', '${name}')">${name}</li>`;
        });
        html += '</ul>';
        view.innerHTML = html;
      } catch (err) {
        view.innerHTML = `<p class="error">è¼‰å…¥å¤±æ•—ï¼š${err.message}</p>`;
      }
    }

    // é¡¯ç¤ºå–®ä¸€ç—…äººå•é¡Œ
    async function showPatientDetail(patientId, patientName) {
      const view = document.getElementById('view');
      view.innerHTML = `<div class="back-btn"><button onclick="showPatientList()">â¬… å›ç—…æˆ¿åˆ—è¡¨</button></div>
                        <h2>ç—…äººï¼š${patientName}</h2>
                        <div class="conditions" id="conditionsList">è¼‰å…¥å•é¡Œä¸­...</div>
                        <div class="form-group">
                          <input type="text" id="newCondition" placeholder="è¼¸å…¥æ–°å•é¡Œï¼ˆä¾‹å¦‚ï¼šé«˜è¡€å£“ã€è‚ºç‚ï¼‰" />
                          <button onclick="addCondition('${patientId}')">æ–°å¢å•é¡Œ</button>
                        </div>
                        <div id="msg"></div>`;

      try {
        const res = await fetch(`${FHIR_BASE}/Condition?patient=Patient/${patientId}&_sort=-recordedDate`);
        const bundle = await res.json();
        const conditions = bundle.entry ? bundle.entry.map(e => e.resource) : [];

        const listEl = document.getElementById('conditionsList');
        if (conditions.length === 0) {
          listEl.innerHTML = '<p>ç›®å‰ç„¡è¨˜éŒ„å•é¡Œã€‚</p>';
        } else {
          let html = '<h3>ç¾æœ‰å•é¡Œï¼š</h3>';
          conditions.forEach(cond => {
            const status = cond.clinicalStatus?.coding?.[0]?.code || 'unknown';
            const display = cond.code?.text || cond.code?.coding?.[0]?.display || 'æœªçŸ¥è¨ºæ–·';
            const recorded = cond.recordedDate ? new Date(cond.recordedDate).toLocaleString('zh-TW') : '';
            html += `<div class="condition-item">
                      ğŸ“Œ ${display} 
                      <span style="color: ${status === 'active' ? 'green' : 'gray'}">(${status})</span>
                      ${recorded ? `<br><small>è¨˜éŒ„æ™‚é–“ï¼š${recorded}</small>` : ''}
                    </div>`;
          });
          listEl.innerHTML = html;
        }
      } catch (err) {
        document.getElementById('conditionsList').innerHTML = `<p class="error">è¼‰å…¥å•é¡Œå¤±æ•—ï¼š${err.message}</p>`;
      }
    }

    // æ–°å¢ Condition
    async function addCondition(patientId) {
      const input = document.getElementById('newCondition');
      const msgEl = document.getElementById('msg');
      const text = input.value.trim();
      if (!text) {
        msgEl.innerHTML = '<p class="error">è«‹è¼¸å…¥å•é¡Œæè¿°</p>';
        return;
      }

      const newCondition = {
        resourceType: "Condition",
        clinicalStatus: {
          coding: [{
            system: "http://terminology.hl7.org/CodeSystem/condition-clinical",
            code: "active",
            display: "Active"
          }]
        },
        verificationStatus: {
          coding: [{
            system: "http://terminology.hl7.org/CodeSystem/condition-ver-status",
            code: "confirmed",
            display: "Confirmed"
          }]
        },
        code: {
          text: text
        },
        subject: {
          reference: `Patient/${patientId}`
        },
        recordedDate: new Date().toISOString()
      };

      try {
        msgEl.innerHTML = '<p>æ–°å¢ä¸­...</p>';
        const res = await fetch(`${FHIR_BASE}/Condition`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/fhir+json' },
          body: JSON.stringify(newCondition)
        });

        if (res.ok) {
          msgEl.innerHTML = '<p class="success">âœ… å•é¡Œæ–°å¢æˆåŠŸï¼</p>';
          input.value = '';
          // é‡æ–°è¼‰å…¥ç—…äººé é¢ï¼ˆç°¡åŒ–ï¼šç›´æ¥é‡æ•´ï¼‰
          const patientName = document.querySelector('h2').textContent.replace('ç—…äººï¼š', '');
          showPatientDetail(patientId, patientName);
        } else {
          const errText = await res.text();
          msgEl.innerHTML = `<p class="error">âŒ æ–°å¢å¤±æ•—ï¼š${res.status} ${errText}</p>`;
        }
      } catch (err) {
        msgEl.innerHTML = `<p class="error">âŒ ç¶²è·¯éŒ¯èª¤ï¼š${err.message}</p>`;
      }
    }

    // å…¨åŸŸæš´éœ²å‡½å¼çµ¦ onclick ä½¿ç”¨
    window.showPatientList = showPatientList;
    window.showPatientDetail = showPatientDetail;
    window.addCondition = addCondition;

    // å•Ÿå‹•
    showPatientList();
  </script>
</body>
</html>